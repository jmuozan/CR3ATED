<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Viewer with Color and Wireframe Controls</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #controls { position: absolute; top: 10px; left: 10px; z-index: 100; }
    #color-controls { position: absolute; top: 10px; right: 10px; z-index: 100; background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 5px; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/exporters/STLExporter.js"></script> <!-- STLExporter -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script> <!-- OrbitControls -->

  <div id="controls">
    <label for="subdivisionsRange">Subdivisions: <span id="subdivisionsValue">12</span></label>
    <input type="range" id="subdivisionsRange" min="3" max="32" step="1" value="12">
    <br>
    <button onclick="exportSTL()">Export .stl</button>
  </div>

  <div id="color-controls">
    <label for="bgColor">Background Color: </label>
    <input type="color" id="bgColor" value="#ffffff">
    <br>
    <label for="lineColor">Line Color: </label>
    <input type="color" id="lineColor" value="#000000">
    <br>
    <label for="shapeColor">Shape Color: </label>
    <input type="color" id="shapeColor" value="#0077ff">
  </div>

  <script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    const pointsData = [
      { "x": 1096, "y": 154 },
      { "x": 1065.1490478515625, "y": 178.56747436523438 },
      { "x": 1033.9317626953125, "y": 202.66770935058594 },
      { "x": 1002.3198852539062, "y": 226.24794006347656 },
      { "x": 970.2820434570312, "y": 249.24571228027344 },
      { "x": 937.7821655273438, "y": 271.58563232421875 },
      { "x": 904.77978515625, "y": 293.1758728027344 },
      { "x": 871.2286987304688, "y": 313.90252685546875 },
      { "x": 837.0769653320312, "y": 333.6228942871094 },
      { "x": 802.26611328125, "y": 352.1539001464844 },
      { "x": 766.7324829101562, "y": 369.25616455078125 },
      { "x": 730.4107055664062, "y": 384.60968017578125 },
      { "x": 693.2427978515625, "y": 397.77581787109375 },
      { "x": 655.2020263671875, "y": 408.1378173828125 },
      { "x": 616.3524169921875, "y": 414.81097412109375 },
      { "x": 576.9863891601562, "y": 416.5262451171875 },
      { "x": 537.9255981445312, "y": 411.56121826171875 },
      { "x": 500.99212646484375, "y": 398.03350830078125 },
      { "x": 469.11187744140625, "y": 375.05023193359375 },
      { "x": 445.0000915527344, "y": 344.0001525878906 }
    ];

    const points = pointsData.map(p => new THREE.Vector2(p.x, p.y));

    let subdivisions = 12;

    // Two separate materials for solid and wireframe
    const solidMaterial = new THREE.MeshPhongMaterial({ color: 0x0077ff });
    const wireframeMaterial = new THREE.MeshBasicMaterial({ color: 0x000000, wireframe: true });

    let latheGeometry = new THREE.LatheGeometry(points, subdivisions);
    let solidMesh = new THREE.Mesh(latheGeometry, solidMaterial);
    let wireframeMesh = new THREE.Mesh(latheGeometry, wireframeMaterial);

    scene.add(solidMesh);
    scene.add(wireframeMesh);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(0, 1, 1).normalize();
    scene.add(light);

    adjustCameraToObject(solidMesh);

    renderer.setClearColor(0xffffff); // Default background color

    function animate() {
      requestAnimationFrame(animate);
      solidMesh.rotation.y += 0.01; // Continuous rotation for both meshes
      wireframeMesh.rotation.y += 0.01;
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function updateGeometry() {
      scene.remove(solidMesh);
      scene.remove(wireframeMesh);

      latheGeometry = new THREE.LatheGeometry(points, subdivisions);
      solidMesh = new THREE.Mesh(latheGeometry, solidMaterial);
      wireframeMesh = new THREE.Mesh(latheGeometry, wireframeMaterial);

      scene.add(solidMesh);
      scene.add(wireframeMesh);

      adjustCameraToObject(solidMesh);
    }

    function adjustCameraToObject(object) {
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());

      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = THREE.MathUtils.degToRad(camera.fov);
      const cameraZ = maxDim / (2 * Math.tan(fov / 2));
      camera.position.set(center.x, center.y, cameraZ * 1.5);

      controls.target.copy(center);
      controls.update();

      camera.far = cameraZ * 3;
      camera.updateProjectionMatrix();
    }

    document.getElementById('subdivisionsRange').addEventListener('input', (event) => {
      subdivisions = parseInt(event.target.value);
      document.getElementById('subdivisionsValue').textContent = subdivisions;
      updateGeometry();
    });

    // Color change listeners
    document.getElementById('bgColor').addEventListener('input', (event) => {
      const color = event.target.value;
      renderer.setClearColor(color);
    });

    document.getElementById('lineColor').addEventListener('input', (event) => {
      const color = event.target.value;
      wireframeMaterial.color.set(color);
    });

    document.getElementById('shapeColor').addEventListener('input', (event) => {
      const color = event.target.value;
      solidMaterial.color.set(color);
    });

    function exportSTL() {
      const exporter = new THREE.STLExporter();
      const stlData = exporter.parse(solidMesh); // Exporting solid mesh
      const blob = new Blob([stlData], { type: 'text/plain' });
      const link = document.createElement('a');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.href = URL.createObjectURL(blob);
      link.download = 'latheShape.stl';
      link.click();
    }
  </script>
</body>
</html>